# Leaderboard API

This repo is implementaion of task provided by ScaleTech. Below are the task points.
We need to develop a micro service that should calculate the user's ranking similar to Leaderboard for the win amount they get.
1. Data is generated from any micro service & pushed to RabbitMQ message broker.

2. Data generated which is pushed to RabbitMQ is
- userId, gameId, transactionId, betAmount, winAmount
win amount will be 0 if user lose & win amount will be greater than 0 if user wins. 

3. There would be Consumer (Leaderboard) Micro Service that would consume the event from RabbitMq & process this data & store it in its own database. 
You can think of XP point when user wins. It should be proportional not just to win amount but consider bet amount what user placed.
Higher the XP point, higher the ranking.

For now consider weekly leaderboard.
At the end of week, all the data should be flushed and logged in any other storage (s3, database or any other option you think is good)

4. Leaderboard stats should be available via API. also user who makes a request should be able to see own position.

5. As we need to consider handling  data at scale, we should at least consider processing 10k concurrent events per second & benchmark our results with load esting with different configuration with vCPU. 

Choose your preferred set of components like database, cache mechanism & and how you execute this task.

## Implementation

Three node servers are created for 3 different purposes as explained below

1. Generator-API: Contains a single api which calculates the win amount based on betamount. Please note the following points of this server.
    - Can run a single instance using `` npm start `` or in cluster mode using `` npm run clustered ``. Runs on `` 3000 `` and `` 3001 `` port respectively. Can be changed in `` configs\server.js ``.
    - Currently the `` /api/bet/ `` does not take any input and generates input data on its own. To do that `` randomWords `` npm package is used for names and `` Math.random() `` is used for betAmount. This can be changed in `` routes\bet.js `` file as randomWords might have performace implications.
    - Message queue name `` jobs `` is used for rabbitmq and it's connection config is present in `` configs\rabbitmq.js ``.

2. Processor: The sole purpose of this server is to read data generated by `` Generator-API ``. Compute XP and structure it in `` redis ``. More details are below.
    - Reads the payload from `` jobs `` queue, parses it and calculates XP based on `` winAmount `` and `` betAmount ``.
    - This `` XP `` is used to generate the Leaderboard Data in redis. To accomplish this `` Sorted Sets `` is used.
    - Main Key of Sorted Set is generated based on `` configs\redisConfig.js `` and `` gameId ``. Calculated `` XP `` is used as `` score `` and user name as `` value ``.
    - The rest of the payload is stored in `` Hash `` whose key is similarly generated based on `` configs\redisConfig.js `` and `` gameId ``.
    - Server can be started using `` npm start `` cmd.

3. Leaderboard-API: Contains `` Leaderboard Stats API `` and `` Weekly Data Dump `` cron job. More details are below.
    - Can run a single instance using `` npm start `` or in cluster mode using `` npm run clustered ``. Runs on `` 4000 `` and `` 4001 `` port respectively. Can be changed in `` configs\server.js ``.
    - API to access leaderboard stats is `` /api/leaderboard/getStats `` as a `` GET `` method. Query parameter `` ?user={userName} `` is mandatory. Optional parameters include 
        - `` offset=5 ``, defaults to ``10``. Till which rank to load stats.
        - `` gameId=1 ``, defaults to ``1``. Load data of specific game id
    - This API retuns the top winners and the position of specified user.
    - The other function of this server is to dump week's leaderboard data in Mongo db, it's configuration is available in `` configs/mongoConfig.js ``.
    - Cron job only runs once even in cluster mode.

## Load Testing

Load testing for Generator-API is done using "autocannon" npm package.
    - Node run command: `` npm run clustered ``
    - Test command: `` autocannon -c200 -p120 -d20 localhost:3001/api/bet ``
    - Results were close to 10k request/sec without randomWords package.

Load testing for Generator-API is done using "autocannon" npm package.
    - Node run command: `` npm run clustered ``
    - Test command: `` autocannon -c200 -p120 -d20 localhost:4001/api/leaderboard/getStats?user=naman ``
    - Results were close to 6k request/sec avg.